<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>Extensible Prioritization Scheme for HTTP</title>

  
<style type="text/css">/*<![CDATA[*/

body {
  font: 16px "Helvetica Neue","Open Sans",Helvetica,Calibri,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 24px;
  margin: 75px auto;
  max-width: 624px;
  padding: 0 5px;
}

.title, .filename, h1, h2, h3, h4, h5 {
  font: 16px "Roboto Condensed","Helvetica Neue","Open Sans",Helvetica,Calibri,sans-serif;
  font-size-adjust: 0.5;
  font-weight: bold;
  color: #333;
  line-height: 100%;
  margin: 1.2em 0 0.3em;
}
.title, #rfc\.title h1 { font-size: 32px; }
h1, section h1, h2, section h2, section h3, nav h2 { font-size: 20px; }
h3, section h4, h4, section h5 { font-size: 16px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header, table#rfc\.headerblock {
  width: 100%;
}
table.header td, table#rfc\.headerblock td {
  border: none;
  background-color: transparent;
  color: black;
  padding: 0;
}
.filename {
  display: block;
  color: rgb(119, 119, 119);
  font-size: 20px;
  font-weight: normal;
  line-height: 100%;
  margin: 10px 0 32px;
}
#rfc\.abstract+p, #rfc\.abstract+p code, #rfc\.abstract+p samp, #rfc\.abstract+p tt {
  font-size: 20px;
  line-height: 28px;
}

samp, tt, code, pre, span.tt {
  font-size: 13.5px;
  font-family: Consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure, caption {
  font-style: italic;
  margin: 0 1.5em;
  text-align: left;
}

address {
  margin: 16px 2px;
  line-height: 20px;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn, address b {
  font-weight: normal;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}
hr.noprint {
  display: none;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

p, ol, ul, li {
  padding: 0;
}
p {
  margin: 0.5em 0;
}
ol, ul {
  margin: 0.2em 0 0.2em 2em;
}
li {
  margin: 0.2em 0;
}
address {
  font-style: normal;
}

ul.toc ul {
  margin: 0 0 0 2em;
}
ul.toc li {
  list-style: none;
  margin: 0;
}

@media screen and (min-width: 924px) {
  body {
    padding-right: 350px;
  }
  body>ul.toc, body>#rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    z-index: 1;
    overflow: auto;
    overscroll-behavior: contain;
  }
  body>#rfc\.toc {
    top: 55px;
  }
  body>ul.toc {
    top: 100px;
  }

  ul.toc {
    margin: 0 0 0 4px;
    font-size: 12px;
    line-height: 20px;
  }
  ul.toc ul {
    margin-left: 1.2em;
  }
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
/*]]>*/</style>
<meta name="viewport" content="initial-scale=1.0">


  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Notational Conventions">
<link href="#rfc.section.2" rel="Chapter" title="2 Motivation for Replacing HTTP/2 Priorities">
<link href="#rfc.section.3" rel="Chapter" title="3 Negotiating Priorities">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 The SETTINGS_PRIORITIES SETTINGS Parameter">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Defined Prioritization Scheme Values">
<link href="#rfc.section.3.2.1" rel="Chapter" title="3.2.1 H2_TREE">
<link href="#rfc.section.3.2.2" rel="Chapter" title="3.2.2 URGENCY">
<link href="#rfc.section.4" rel="Chapter" title="4 The Priority Parameters">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 urgency">
<link href="#rfc.section.4.1.1" rel="Chapter" title="4.1.1 prerequisite">
<link href="#rfc.section.4.1.2" rel="Chapter" title="4.1.2 default">
<link href="#rfc.section.4.1.3" rel="Chapter" title="4.1.3 supplementary">
<link href="#rfc.section.4.1.4" rel="Chapter" title="4.1.4 background">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 incremental">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Defining New Parameters">
<link href="#rfc.section.5" rel="Chapter" title="5 The Priority HTTP Header Field">
<link href="#rfc.section.6" rel="Chapter" title="6 Reprioritization">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 HTTP/2 PRIORITY_UPDATE Frame">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 HTTP/3 PRIORITY_UPDATE Frame">
<link href="#rfc.section.7" rel="Chapter" title="7 Merging Client- and Server-Driven Parameters">
<link href="#rfc.section.8" rel="Chapter" title="8 Security Considerations">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 Fairness">
<link href="#rfc.section.8.1.1" rel="Chapter" title="8.1.1 Coalescing Intermediaries">
<link href="#rfc.section.8.1.2" rel="Chapter" title="8.1.2 HTTP/1.x Back Ends">
<link href="#rfc.section.8.1.3" rel="Chapter" title="8.1.3 Intentional Introduction of Unfairness">
<link href="#rfc.section.9" rel="Chapter" title="9 Considerations">
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 Why use an End-to-End Header Field?">
<link href="#rfc.section.9.2" rel="Chapter" title="9.2 Why do Urgencies Have Meanings?">
<link href="#rfc.section.9.3" rel="Chapter" title="9.3 Can an Intermediary Send its own Signal?">
<link href="#rfc.section.10" rel="Chapter" title="10 IANA Considerations">
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 HTTP Prioritization Scheme Registry">
<link href="#rfc.references" rel="Chapter" title="11 References">
<link href="#rfc.references.1" rel="Chapter" title="11.1 Normative References">
<link href="#rfc.references.2" rel="Chapter" title="11.2 Informative References">
<link href="#rfc.appendix.A" rel="Chapter" title="A Acknowledgements">
<link href="#rfc.appendix.B" rel="Chapter" title="B Change Log">
<link href="#rfc.appendix.B.1" rel="Chapter" title="B.1 Since draft-kazuho-httpbis-priority-03">
<link href="#rfc.appendix.B.2" rel="Chapter" title="B.2 Since draft-kazuho-httpbis-priority-02">
<link href="#rfc.appendix.B.3" rel="Chapter" title="B.3 Since draft-kazuho-httpbis-priority-01">
<link href="#rfc.appendix.B.4" rel="Chapter" title="B.4 Since draft-kazuho-httpbis-priority-00">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.23.1 - https://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Oku, K. and L. Pardue" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-kazuho-httpbis-priority-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2019-11-20" />
  <meta name="dct.abstract" content="This document describes a scheme for prioritizing HTTP responses. This scheme expresses the priority of each HTTP response using absolute values, rather than as a relative relationship between a group of HTTP responses.This document defines the Priority header field for communicating the initial priority in an HTTP version-independent manner, as well as HTTP/2 and HTTP/3 frames for reprioritizing the responses. These share a common format structure that is designed to provide future extensibility." />
  <meta name="description" content="This document describes a scheme for prioritizing HTTP responses. This scheme expresses the priority of each HTTP response using absolute values, rather than as a relative relationship between a group of HTTP responses.This document defines the Priority header field for communicating the initial priority in an HTTP version-independent manner, as well as HTTP/2 and HTTP/3 frames for reprioritizing the responses. These share a common format structure that is designed to provide future extensibility." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left">HTTP</td>
<td class="right">K. Oku</td>
</tr>
<tr>
<td class="left">Internet-Draft</td>
<td class="right">Fastly</td>
</tr>
<tr>
<td class="left">Intended status: Standards Track</td>
<td class="right">L. Pardue</td>
</tr>
<tr>
<td class="left">Expires: May 23, 2020</td>
<td class="right">Cloudflare</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">November 20, 2019</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">Extensible Prioritization Scheme for HTTP<br />
  <span class="filename">draft-kazuho-httpbis-priority-latest</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>This document describes a scheme for prioritizing HTTP responses. This scheme expresses the priority of each HTTP response using absolute values, rather than as a relative relationship between a group of HTTP responses.</p>
<p>This document defines the Priority header field for communicating the initial priority in an HTTP version-independent manner, as well as HTTP/2 and HTTP/3 frames for reprioritizing the responses. These share a common format structure that is designed to provide future extensibility.</p>
<h1 id="rfc.status"><a href="#rfc.status">Status of This Memo</a></h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at https://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on May 23, 2020.</p>
<h1 id="rfc.copyrightnotice"><a href="#rfc.copyrightnotice">Copyright Notice</a></h1>
<p>Copyright (c) 2019 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (https://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Notational Conventions</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Motivation for Replacing HTTP/2 Priorities</a>
</li>
<li>3.   <a href="#rfc.section.3">Negotiating Priorities</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">The SETTINGS_PRIORITIES SETTINGS Parameter</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Defined Prioritization Scheme Values</a>
</li>
<ul><li>3.2.1.   <a href="#rfc.section.3.2.1">H2_TREE</a>
</li>
<li>3.2.2.   <a href="#rfc.section.3.2.2">URGENCY</a>
</li>
</ul></ul><li>4.   <a href="#rfc.section.4">The Priority Parameters</a>
</li>
<ul><li>4.1.   <a href="#rfc.section.4.1">urgency</a>
</li>
<ul><li>4.1.1.   <a href="#rfc.section.4.1.1">prerequisite</a>
</li>
<li>4.1.2.   <a href="#rfc.section.4.1.2">default</a>
</li>
<li>4.1.3.   <a href="#rfc.section.4.1.3">supplementary</a>
</li>
<li>4.1.4.   <a href="#rfc.section.4.1.4">background</a>
</li>
</ul><li>4.2.   <a href="#rfc.section.4.2">incremental</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Defining New Parameters</a>
</li>
</ul><li>5.   <a href="#rfc.section.5">The Priority HTTP Header Field</a>
</li>
<li>6.   <a href="#rfc.section.6">Reprioritization</a>
</li>
<ul><li>6.1.   <a href="#rfc.section.6.1">HTTP/2 PRIORITY_UPDATE Frame</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">HTTP/3 PRIORITY_UPDATE Frame</a>
</li>
</ul><li>7.   <a href="#rfc.section.7">Merging Client- and Server-Driven Parameters</a>
</li>
<li>8.   <a href="#rfc.section.8">Security Considerations</a>
</li>
<ul><li>8.1.   <a href="#rfc.section.8.1">Fairness</a>
</li>
<ul><li>8.1.1.   <a href="#rfc.section.8.1.1">Coalescing Intermediaries</a>
</li>
<li>8.1.2.   <a href="#rfc.section.8.1.2">HTTP/1.x Back Ends</a>
</li>
<li>8.1.3.   <a href="#rfc.section.8.1.3">Intentional Introduction of Unfairness</a>
</li>
</ul></ul><li>9.   <a href="#rfc.section.9">Considerations</a>
</li>
<ul><li>9.1.   <a href="#rfc.section.9.1">Why use an End-to-End Header Field?</a>
</li>
<li>9.2.   <a href="#rfc.section.9.2">Why do Urgencies Have Meanings?</a>
</li>
<li>9.3.   <a href="#rfc.section.9.3">Can an Intermediary Send its own Signal?</a>
</li>
</ul><li>10.   <a href="#rfc.section.10">IANA Considerations</a>
</li>
<ul><li>10.1.   <a href="#rfc.section.10.1">HTTP Prioritization Scheme Registry</a>
</li>
</ul><li>11.   <a href="#rfc.references">References</a>
</li>
<ul><li>11.1.   <a href="#rfc.references.1">Normative References</a>
</li>
<li>11.2.   <a href="#rfc.references.2">Informative References</a>
</li>
</ul><li>Appendix A.   <a href="#rfc.appendix.A">Acknowledgements</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.B">Change Log</a>
</li>
<ul><li>B.1.   <a href="#rfc.appendix.B.1">Since draft-kazuho-httpbis-priority-03</a>
</li>
<li>B.2.   <a href="#rfc.appendix.B.2">Since draft-kazuho-httpbis-priority-02</a>
</li>
<li>B.3.   <a href="#rfc.appendix.B.3">Since draft-kazuho-httpbis-priority-01</a>
</li>
<li>B.4.   <a href="#rfc.appendix.B.4">Since draft-kazuho-httpbis-priority-00</a>
</li>
</ul><li><a href="#rfc.authors">Authors' Addresses</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#introduction" id="introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">It is common for an HTTP (<a href="#RFC7230" class="xref">[RFC7230]</a>) resource representation to have relationships to one or more other resources.  Clients will often discover these relationships while processing a retrieved representation, leading to further retrieval requests.  Meanwhile, the nature of the relationship determines whether the client is blocked from continuing to process locally available resources.  For example, visual rendering of an HTML document could be blocked by the retrieval of a CSS file that the document refers to.  In contrast, inline images do not block rendering and get drawn incrementally as the chunks of the images arrive.</p>
<p id="rfc.section.1.p.2">To provide meaningful representation of a document at the earliest moment, it is important for an HTTP server to prioritize the HTTP responses, or the chunks of those HTTP responses, that it sends.</p>
<p id="rfc.section.1.p.3">HTTP/2 (<a href="#RFC7540" class="xref">[RFC7540]</a>) provides such a prioritization scheme. A client sends a series of PRIORITY frames to communicate to the server a &#8220;priority tree&#8221;; this represents the client&#8217;s preferred ordering and weighted distribution of the bandwidth among the HTTP responses. However, the design and implementation of this scheme has been observed to have shortcomings, explained in <a href="#motivation" class="xref">Section 2</a>.</p>
<p id="rfc.section.1.p.4">This document defines the Priority HTTP header field that can be used by both client and server to specify the precedence of HTTP responses in a standardized, extensible, protocol-version-independent, end-to-end format. Along with the protocol-version-specific frame for reprioritization, this prioritization scheme acts as a substitute for the original prioritization scheme of HTTP/2.</p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#notational-conventions" id="notational-conventions">Notational Conventions</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;REQUIRED&#8221;, &#8220;SHALL&#8221;, &#8220;SHALL NOT&#8221;, &#8220;SHOULD&#8221;, &#8220;SHOULD NOT&#8221;, &#8220;RECOMMENDED&#8221;, &#8220;MAY&#8221;, and &#8220;OPTIONAL&#8221; in this document are to be interpreted as described in <a href="#RFC2119" class="xref">[RFC2119]</a>.</p>
<p id="rfc.section.1.1.p.2">The terms sh-token and sh-boolean are imported from <a href="#STRUCTURED-HEADERS" class="xref">[STRUCTURED-HEADERS]</a>.</p>
<p id="rfc.section.1.1.p.3">Example HTTP requests and responses use the HTTP/2-style formatting from <a href="#RFC7540" class="xref">[RFC7540]</a>.</p>
<p id="rfc.section.1.1.p.4">This document uses the variable-length integer encoding from <a href="#I-D.ietf-quic-transport" class="xref">[I-D.ietf-quic-transport]</a>.</p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#motivation" id="motivation">Motivation for Replacing HTTP/2 Priorities</a>
</h1>
<p id="rfc.section.2.p.1">An important feature of any implementation of a protocol that provides multiplexing is the ability to prioritize the sending of information. This was an important realization in the design of HTTP/2. Prioritization is a difficult problem, so it will always be suboptimal, particularly if one endpoint operates in ignorance of the needs of its peer.</p>
<p id="rfc.section.2.p.2">HTTP/2 introduced a complex prioritization signaling scheme that used a combination of dependencies and weights, formed into an unbalanced tree. This scheme has suffered from poor deployment and interoperability.</p>
<p id="rfc.section.2.p.3">The rich flexibility of client-driven HTTP/2 prioritization tree building is rarely exercised; experience shows that clients either choose a single model optimized for a web use case (and don&#8217;t vary it) or do nothing at all. But every client builds their prioritization tree in a different way, which makes it difficult for servers to understand their intent and act or intervene accordingly.</p>
<p id="rfc.section.2.p.4">Many HTTP/2 server implementations do not include support for the priority scheme, some favoring instead bespoke server-driven schemes based on heuristics and other hints, like the content type of resources and the order in which requests arrive. For example, a server, with knowledge of the document structure, might want to prioritize the delivery of images that are critical to user experience above other images, but below the CSS files. Since client trees vary, it is impossible for the server to determine how such images should be prioritized against other responses.</p>
<p id="rfc.section.2.p.5">The HTTP/2 scheme allows intermediaries to coalesce multiple client trees into a single tree that is used for a single upstream HTTP/2 connection. However, most intermediaries do not support this. The scheme does not define a method that can be used by a server to express the priority of a response. Without such a method, intermediaries cannot coordinate client-driven and server-driven priorities.</p>
<p id="rfc.section.2.p.6">HTTP/2 describes denial-of-service considerations for implementations. On 2019-08-13 Netflix issued an advisory notice about the discovery of several resource exhaustion vectors affecting multiple HTTP/2 implementations. One attack, CVE-2019-9513 aka &#8220;Resource Loop&#8221;, is based on manipulation of the priority tree.</p>
<p id="rfc.section.2.p.7">The HTTP/2 scheme depends on in-order delivery of signals, leading to challenges in porting the scheme to protocols that do not provide global ordering. For example, the scheme cannot be used in HTTP/3 <a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a> without changing the signal and its processing.</p>
<p id="rfc.section.2.p.8">Considering the problems with deployment and adaptability to HTTP/3, retaining the HTTP/2 priority scheme increases the complexity of the entire system without any evidence that the value it provides offsets that complexity. In fact, multiple experiments from independent research have shown that simpler schemes can reach at least equivalent performance characteristics compared to the more complex HTTP/2 setups seen in practice, at least for the web use case.</p>
<p id="rfc.section.2.p.9">The problems and insights laid out above are motivation for the alternative and more straightforward prioritization scheme presented in this document. In order to support deployment of new schemes, a general-purpose negotiation mechanism is specified in <a href="#negotiating-priorities" class="xref">Section 3</a>.</p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#negotiating-priorities" id="negotiating-priorities">Negotiating Priorities</a>
</h1>
<p id="rfc.section.3.p.1">The document specifies a negotiation mechanism that allows each peer to communicate which, if any, priority schemes are supported, as well as the server&#8217;s ranked preference.</p>
<p id="rfc.section.3.p.2">For both HTTP/2 and HTTP/3, either peer&#8217;s SETTINGS may arrive first, so any negotiation must be unilateral and not rely upon receiving the peer&#8217;s SETTINGS value.</p>
<p id="rfc.section.3.p.3">Servers are likely to only use one prioritization scheme at once per each connection, and may be unable to change the scheme once established, so the setting MUST be sent prior to the first request if it is ever sent. In HTTP/3, SETTINGS might arrive after the first request even if they are sent first.  Therefore, future specifications that define alternative prioritization schemes for HTTP/3 SHOULD define how the server would act when it receives a stream-level priority signal prior to receiving the SETTINGS frame.</p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#the-settingspriorities-settings-parameter" id="the-settingspriorities-settings-parameter">The SETTINGS_PRIORITIES SETTINGS Parameter</a>
</h1>
<p id="rfc.section.3.1.p.1">This document defines a new SETTINGS_PRIORITIES parameter (0x9) for HTTP/2 and HTTP/3, which allows both peers to indicate which prioritization schemes they support. The value of this parameter is interpreted in two ways depending on if it is zero or non-zero.</p>
<p id="rfc.section.3.1.p.2">If the setting has a value of zero it indicates no support for priorities. If either side sends the parameter with a value of zero, clients SHOULD NOT send hop-by-hop priority signals (e.g., HTTP/2 PRIORITY frame) and servers SHOULD NOT make any assumptions based on the presence or lack thereof of such signals.</p>
<p id="rfc.section.3.1.p.3">If the value is non-zero, then it is interpreted as an ordered preference list of prioritization schemes represented by 8-bit values. The least significant 8 bits indicate the sender&#8217;s most preferred priority scheme, the second least significant 8 bits indicate the sender&#8217;s second choice, and so on. This allows expressing support for 4 schemes in HTTP/2 and 7 in HTTP/3.</p>
<p id="rfc.section.3.1.p.4">A sender MUST comply with the following restrictions when constructing a preference list: duplicate 8-bit values (excluding the value 0) MUST NOT be used, and if any byte is 0 then all more significant bytes MUST also be 0. An endpoint that receives a setting in violation of these requirements MUST treat it as a connection error of type PROTOCOL_ERROR for HTTP/2 <a href="#RFC7540" class="xref">[RFC7540]</a>, or of type H3_SETTINGS_ERROR for HTTP/3 <a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a>.</p>
<p id="rfc.section.3.1.p.5">In HTTP/2, the setting SHOULD appear in the first SETTINGS frame and peers MUST NOT process the setting if it is received multiple times in order to avoid changing the agreed upon prioritization scheme.</p>
<p id="rfc.section.3.1.p.6">If there is a prioritization scheme supported by both the client and server, then the server&#8217;s preference order prevails and both peers SHOULD only use the agreed upon priority scheme for the remainder of the session.  The server chooses because it is in the best position to know what information from the client is of the most value.</p>
<p id="rfc.section.3.1.p.7">Once the negotiation is complete, endpoints MAY stop sending hop-by-hop prioritization signals that were not negotiated in order to conserve bandwidth.  However, endpoints SHOULD continue sending end-to-end signals (e.g., the Priority header field), as that might have meaningful effect to other nodes that handle the HTTP message.</p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#defined-prioritization-scheme-values" id="defined-prioritization-scheme-values">Defined Prioritization Scheme Values</a>
</h1>
<p id="rfc.section.3.2.p.1">This document defines two prioritization scheme values for use with the SETTINGS_PRIORITIES setting.</p>
<h1 id="rfc.section.3.2.1">
<a href="#rfc.section.3.2.1">3.2.1.</a> <a href="#settings-h2-scheme" id="settings-h2-scheme">H2_TREE</a>
</h1>
<p id="rfc.section.3.2.1.p.1">This document defines the priority scheme identifier H2_TREE (8-bit value of 1) that indicates support for HTTP/2-style priorities (<a href="#RFC7540" class="xref">[RFC7540]</a>, Section 5.3).</p>
<p id="rfc.section.3.2.1.p.2">The H2_TREE priority scheme identifier MUST NOT be be sent in an HTTP/3 settings because there is no defined mapping of this scheme. Endpoints MUST treat receipt of H2_TREE as a connection error of type H3_SETTINGS_ERROR.</p>
<h1 id="rfc.section.3.2.2">
<a href="#rfc.section.3.2.2">3.2.2.</a> <a href="#settings-this-scheme" id="settings-this-scheme">URGENCY</a>
</h1>
<p id="rfc.section.3.2.2.p.1">This document defines the priority scheme identifier URGENCY (8-bit value of 2) that indicates support for the extensible priority scheme defined in the present document.</p>
<p id="rfc.section.3.2.2.p.2">An intermediary connecting to a backend server SHOULD declare support for the extensible priority scheme when and only when all the requests that are to be sent on that backend connection originates from one client-side connection that has negotiated the use of the extensible priority scheme (see <a href="#fairness" class="xref">Section 8.1</a>).</p>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#the-priority-parameters" id="the-priority-parameters">The Priority Parameters</a>
</h1>
<p id="rfc.section.4.p.1">The priority information is a sequence of key-value pairs, providing room for future extensions. Each key-value pair represents a priority parameter.</p>
<p id="rfc.section.4.p.2">The Priority HTTP header field is used to transmit this set of parameters when a request or a response is being issued. In order to request reprioritization after the requests have been issued, HTTP-version-specific frames are used by clients to transmit this same information.</p>
<p id="rfc.section.4.p.3">In both cases, the set of priority parameters is encoded as a Structured Headers Dictionary (<a href="#STRUCTURED-HEADERS" class="xref">[STRUCTURED-HEADERS]</a>).</p>
<p id="rfc.section.4.p.4">This document defines the urgency(<samp>u</samp>) and incremental(<samp>i</samp>) parameters. When used, these parameters MUST be accompanied by values. When any of the defined parameters are omitted, or if the Priority header field is not used, their default values SHOULD be applied.</p>
<p id="rfc.section.4.p.5">Unknown parameters, parameters with out-of-range values or values of unexpected types MUST be ignored.</p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#urgency" id="urgency">urgency</a>
</h1>
<p id="rfc.section.4.1.p.1">The urgency(<samp>u</samp>) parameter takes an integer between 0 and 7, in descending order of priority, as shown below:</p>
<div id="rfc.table.1"></div>
<div id="urgencies"></div>
<table cellpadding="3" cellspacing="0" class="tt full center">
<caption>Urgencies</caption>
<thead><tr>
<th class="right">Urgency</th>
<th class="left">Definition</th>
</tr></thead>
<tbody>
<tr>
<td class="right">0</td>
<td class="left">prerequisite (<a href="#prerequisite" class="xref">Section 4.1.1</a>)</td>
</tr>
<tr>
<td class="right">1</td>
<td class="left">default (<a href="#default" class="xref">Section 4.1.2</a>)</td>
</tr>
<tr>
<td class="right">between 2 and 6</td>
<td class="left">supplementary (<a href="#supplementary" class="xref">Section 4.1.3</a>)</td>
</tr>
<tr>
<td class="right">7</td>
<td class="left">background (<a href="#background" class="xref">Section 4.1.4</a>)</td>
</tr>
</tbody>
</table>
<p id="rfc.section.4.1.p.2">The value is encoded as an sh-integer. The default value is 1.</p>
<p id="rfc.section.4.1.p.3">A server SHOULD transmit HTTP responses in the order of their urgency values.  The lower the value, the higher the precedence.</p>
<p id="rfc.section.4.1.p.4">The following example shows a request for a CSS file with the urgency set to <samp>0</samp>:</p>
<pre>
:method = GET
:scheme = https
:authority = example.net
:path = /style.css
priority = u=0
</pre>
<p id="rfc.section.4.1.p.5">The definition of the urgencies and their expected use-case are described below.  Endpoints SHOULD respect the definition of the values when assigning urgencies.</p>
<h1 id="rfc.section.4.1.1">
<a href="#rfc.section.4.1.1">4.1.1.</a> <a href="#prerequisite" id="prerequisite">prerequisite</a>
</h1>
<p id="rfc.section.4.1.1.p.1">The prerequisite urgency (value 0) indicates that the response prevents other responses with an urgency of prerequisite or default from being used until it is fully transmitted.</p>
<p id="rfc.section.4.1.1.p.2">For example, use of an external stylesheet can block a web browser from rendering the HTML. In such case, the stylesheet is given the prerequisite urgency.</p>
<h1 id="rfc.section.4.1.2">
<a href="#rfc.section.4.1.2">4.1.2.</a> <a href="#default" id="default">default</a>
</h1>
<p id="rfc.section.4.1.2.p.1">The default urgency (value 1) indicates a response that is to be used as it is delivered to the client, but one that does not block other responses from being used.</p>
<p id="rfc.section.4.1.2.p.2">For example, when a user using a web browser navigates to a new HTML document, the request for that HTML is given the default urgency.  When that HTML document uses a custom font, the request for that custom font SHOULD also be given the default urgency.  This is because the availability of the custom font is likely a precondition for the user to use that portion of the HTML document, which is to be rendered by that font.</p>
<h1 id="rfc.section.4.1.3">
<a href="#rfc.section.4.1.3">4.1.3.</a> <a href="#supplementary" id="supplementary">supplementary</a>
</h1>
<p id="rfc.section.4.1.3.p.1">The supplementary urgencies (values 2 to 6) indicate a response that is helpful to the client using a composition of responses, even though the response itself is not mandatory for using those responses.</p>
<p id="rfc.section.4.1.3.p.2">For example, inline images (i.e., images being fetched and displayed as part of the document) are visually important elements of an HTML document.  As such, users will typically not be prevented from using the document, at least to some degree, before any or all of these images are loaded. Display of those images are thus considered to be an improvement for visual clients rather than a prerequisite for all user agents.  Therefore, such images will be given the supplementary urgency.</p>
<p id="rfc.section.4.1.3.p.3">Values between 2 and 6 are used to represent this urgency, to provide flexibility to the endpoints for giving some responses more or less precedence than others that belong to the supplementary group. <a href="#merging" class="xref">Section 7</a> explains how these values might be used.</p>
<p id="rfc.section.4.1.3.p.4">Clients SHOULD NOT use values 2 and 6.  Servers MAY use these values to prioritize a response above or below other supplementary responses.</p>
<p id="rfc.section.4.1.3.p.5">Clients MAY use values 3 to indicate that a request is given relatively high priority, or 5 to indicate relatively low priority, within the supplementary urgency group.</p>
<p id="rfc.section.4.1.3.p.6">For example, an image certain to be visible at the top of the page, might be assigned a value of 3 instead of 4, as it will have a high visual impact for the user.  Conversely, an asynchronously loaded JavaScript file might be assigned an urgency value of 5, as it is less likely to have a visual impact.</p>
<p id="rfc.section.4.1.3.p.7">When none of the considerations above is applicable, the value of 3 SHOULD be used.</p>
<h1 id="rfc.section.4.1.4">
<a href="#rfc.section.4.1.4">4.1.4.</a> <a href="#background" id="background">background</a>
</h1>
<p id="rfc.section.4.1.4.p.1">The background urgency (value 7) is used for responses of which the delivery can be postponed without having an impact on using other responses.</p>
<p id="rfc.section.4.1.4.p.2">As an example, the download of a large file in a web browser would be assigned the background urgency so it would not impact further page loads on the same connection.</p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#incremental" id="incremental">incremental</a>
</h1>
<p id="rfc.section.4.2.p.1">The incremental(<samp>i</samp>) parameter takes an sh-boolean as the value that indicates if a response can be processed incrementally, i.e. provide some meaningful output as chunks of the response arrive.</p>
<p id="rfc.section.4.2.p.2">The default value of the incremental parameter is <samp>0</samp>.</p>
<p id="rfc.section.4.2.p.3">A server SHOULD distribute the bandwidth of a connection between incremental responses that share the same urgency.</p>
<p id="rfc.section.4.2.p.4">A server SHOULD transmit non-incremental responses one by one, preferably in the order the requests were generated.  Doing so maximizes the chance of the client making progress in using the composition of the HTTP responses at the earliest moment.</p>
<p id="rfc.section.4.2.p.5">The following example shows a request for a JPEG file with the urgency parameter set to <samp>4</samp> and the incremental parameter set to <samp>1</samp>.</p>
<pre>
:method = GET
:scheme = https
:authority = example.net
:path = /image.jpg
priority = u=4, i=?1
</pre>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#defining-new-parameters" id="defining-new-parameters">Defining New Parameters</a>
</h1>
<p id="rfc.section.4.3.p.1">When attempting to extend priorities, care must be taken to ensure any use of existing parameters are either unchanged or modified in a way that is backwards compatible for peers that are unaware of the extended meaning.</p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#the-priority-http-header-field" id="the-priority-http-header-field">The Priority HTTP Header Field</a>
</h1>
<p id="rfc.section.5.p.1">The Priority HTTP header field can appear in requests and responses. A client uses it to specify the priority of the response. A server uses it to inform the client that the priority was overwritten. An intermediary can use the Priority information from client requests and server responses to correct or amend the precedence to suit it (see <a href="#merging" class="xref">Section 7</a>).</p>
<p id="rfc.section.5.p.2">The Priority header field is an end-to-end signal of the request priority from the client or the response priority from the server.</p>
<p id="rfc.section.5.p.3">As is the ordinary case for HTTP caching (<a href="#RFC7234" class="xref">[RFC7234]</a>), a response with a Priority header field might be cached and re-used for subsequent requests.  When an origin server generates the Priority response header field based on properties of an HTTP request it receives, the server is expected to control the cacheability or the applicability of the cached response, by using header fields that control the caching behavior (e.g., Cache-Control, Vary).</p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#reprioritization" id="reprioritization">Reprioritization</a>
</h1>
<p id="rfc.section.6.p.1">Once a client sends a request, circumstances might change and mean that it is beneficial to change the priority of the response. As an example, a web browser might issue a prefetch request for a JavaScript file with the urgency parameter of the Priority request header field set to <samp>u=7</samp> (background). Then, when the user navigates to a page which references the new JavaScript file, while the prefetch is in progress, the browser would send a reprioritization frame with the priority field value set to <samp>u=0</samp> (prerequisite).</p>
<p id="rfc.section.6.p.2">However, a client cannot reprioritize a response by using the Priority header field. This is because an HTTP header field can only be sent as part of an HTTP message. Therefore, to support reprioritization, it is necessary to define a HTTP-version-dependent mechanism for transmitting the priority parameters.</p>
<p id="rfc.section.6.p.3">This document specifies a new PRIORITY_UPDATE frame type for HTTP/2 (<a href="#RFC7540" class="xref">[RFC7540]</a>) and HTTP/3 (<a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a>) that is specialized for reprioritization. It carries updated priority parameters and references the target of the reprioritization based on a version-specific identifier; in HTTP/2 this is the Stream ID, in HTTP/3 this is either the Stream ID or Push ID.</p>
<p id="rfc.section.6.p.4">In HTTP/2 and HTTP/3, after a request message is sent on a stream, the stream transitions to a state that prevents the client from sending additional frames on the stream. Modifying this behavior would require a semantic change to the protocol, but this is avoided by restricting the stream on which a PRIORITY_UPDATE frame can be sent. In HTTP/2 the frame is on stream zero and in HTTP/3 it is sent on the control stream (<a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a>, Section 6.2.1).</p>
<p id="rfc.section.6.p.5">Unlike the header field, the reprioritization frame is a hop-by-hop signal.</p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#http2-priorityupdate-frame" id="http2-priorityupdate-frame">HTTP/2 PRIORITY_UPDATE Frame</a>
</h1>
<p id="rfc.section.6.1.p.1">The HTTP/2 PRIORITY_UPDATE frame (type=0xF) carries the stream ID of the response that is being reprioritized, and the updated priority in ASCII text, using the same representation as that of the Priority header field value.</p>
<p id="rfc.section.6.1.p.2">The Stream Identifier field (<a href="#RFC7540" class="xref">[RFC7540]</a>, Section 4.1) in the PRIORITY_UPDATE frame header MUST be zero (0x0).</p>
<div id="rfc.figure.1"></div>
<div id="fig-h2-reprioritization-frame"></div>
<pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +---------------------------------------------------------------+
 |R|                        Stream ID (31)                       |
 +---------------------------------------------------------------+
 |                   Priority Field Value (*)                  ...
 +---------------------------------------------------------------+
</pre>
<p class="figure">Figure 1: HTTP/2 PRIORITY_UPDATE Frame Payload</p>
<p id="rfc.section.6.1.p.3">The HTTP/2 PRIORITY_UPDATE frame MUST NOT be sent prior to opening the stream.  If a PRIORITY_UPDATE is received prior to the stream being opened, it MAY be treated as a connection error of type PROTOCOL_ERROR.</p>
<p id="rfc.section.6.1.p.4">TODO: add more description of how to handle things like receiving PRIORITY_UPDATE on wrong stream, a PRIORITY_UPDATE with an invalid ID, etc.</p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> <a href="#http3-priorityupdate-frame" id="http3-priorityupdate-frame">HTTP/3 PRIORITY_UPDATE Frame</a>
</h1>
<p id="rfc.section.6.2.p.1">The HTTP/3 PRIORITY_UPDATE frame (type=0xF) carries the identifier of the element that is being reprioritized, and the updated priority in ASCII text, using the same representation as that of the Priority header field value.</p>
<p id="rfc.section.6.2.p.2">The PRIORITY_UPDATE frame MUST be sent on the control stream (<a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a>, Section 6.2.1).</p>
<div id="rfc.figure.2"></div>
<div id="fig-h3-reprioritization-frame"></div>
<pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |T|    Empty    |   Prioritized Element ID (i)                ...
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                   Priority Field Value (*)                  ...
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
<p class="figure">Figure 2: HTTP/3 PRIORITY_UPDATE Frame Payload</p>
<p id="rfc.section.6.2.p.3">The PRIORITY_UPDATE frame payload has the following fields:</p>
<p></p>

<dl>
<dt>T (Prioritized Element Type):</dt>
<dd style="margin-left: 8">A one-bit field indicating the type of element being prioritized. A value of 0 indicates a reprioritization for a Request Stream, so the Prioritized Element ID is interpreted as a Stream ID. A value of 1 indicates a reprioritization for a Push stream, so the Prioritized Element ID is interpreted as a Push ID.</dd>
<dt>Empty:</dt>
<dd style="margin-left: 8">A seven-bit field that has no semantic value.</dd>
</dl>
<p id="rfc.section.6.2.p.5">The HTTP/3 PRIORITY_UPDATE frame MUST NOT be sent with an invalid identifier, including before the request stream has been opened or before a promised request has been received.  If a server receives a PRIORITY_UPDATE specifying a push ID that has not been promised, it SHOULD be treated as a connection error of type H3_ID_ERROR.</p>
<p id="rfc.section.6.2.p.6">Because the HTTP/3 PRIORITY_UPDATE frame is sent on the control stream and there are no ordering guarantees between streams, a client that reprioritizes a request before receiving the response data might cause the server to receive a PRIORITY_UPDATE for an unknown request. If the request stream ID is within bidirectional stream limits, the PRIORITY_UPDATE frame SHOULD be buffered until the stream is opened and applied immediately after the request message has been processed. Holding PRIORITY_UPDATES consumes extra state on the peer, although the size of the state is bounded by bidirectional stream limits. There is no bound on the number of PRIORITY_UPDATES that can be sent, so an endpoint SHOULD store only the most recently received frame.</p>
<p id="rfc.section.6.2.p.7">TODO: add more description of how to handle things like receiving PRIORITY_UPDATE on wrong stream, a PRIORITY_UPDATE with an invalid ID, etc.</p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#merging" id="merging">Merging Client- and Server-Driven Parameters</a>
</h1>
<p id="rfc.section.7.p.1">It is not always the case that the client has the best understanding of how the HTTP responses deserve to be prioritized. For example, use of an HTML document might depend heavily on one of the inline images. Existence of such dependencies is typically best known to the server.</p>
<p id="rfc.section.7.p.2">By using the &#8220;Priority&#8221; response header, a server can override the prioritization hints provided by the client. When used, the parameters found in the response header field overrides those specified by the client.</p>
<p id="rfc.section.7.p.3">For example, when the client sends an HTTP request with</p>
<pre>
:method = GET
:scheme = https
:authority = example.net
:path = /menu.png
priority = u=4, i=?1
</pre>
<p id="rfc.section.7.p.4">and the origin responds with</p>
<pre>
:status = 200
content-type = image/png
priority = u=2
</pre>
<p id="rfc.section.7.p.5">the intermediary&#8217;s understanding of the urgency is promoted from <samp>4</samp> to <samp>2</samp>, because the server-provided value overrides the value provided by the client.  The incremental value continues to be <samp>1</samp>, the value specified by the client, as the server did not specify the incremental(<samp>i</samp>) parameter.</p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#security-considerations" id="security-considerations">Security Considerations</a>
</h1>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> <a href="#fairness" id="fairness">Fairness</a>
</h1>
<p id="rfc.section.8.1.p.1">As a general guideline, a server SHOULD NOT use priority information for making schedule decisions across multiple connections, unless it knows that those connections originate from the same client. Due to this, priority information conveyed over a non-coalesced HTTP connection (e.g., HTTP/1.1) might go unused.</p>
<p id="rfc.section.8.1.p.2">The remainder of this section discusses scenarios where unfairness is problematic and presents possible mitigations, or where unfairness is desirable.</p>
<h1 id="rfc.section.8.1.1">
<a href="#rfc.section.8.1.1">8.1.1.</a> <a href="#coalescing-intermediaries" id="coalescing-intermediaries">Coalescing Intermediaries</a>
</h1>
<p id="rfc.section.8.1.1.p.1">When an intermediary coalesces HTTP requests coming from multiple clients into one HTTP/2 or HTTP/3 connection going to the backend server, requests that originate from one client might have higher precedence than those coming from others.</p>
<p id="rfc.section.8.1.1.p.2">It is sometimes beneficial for the server running behind an intermediary to obey to the value of the Priority header field. As an example, a resource-constrained server might defer the transmission of software update files that would have the background urgency being associated. However, in the worst case, the asymmetry between the precedence declared by multiple clients might cause responses going to one end client to be delayed totally after those going to another.</p>
<p id="rfc.section.8.1.1.p.3">In order to mitigate this fairness problem, when a server responds to a request that is known to have come through an intermediary, the server SHOULD prioritize the response as if it was assigned the priority of  <samp>u=1, i=?1</samp> (i.e. round-robin) regardless of the value of the Priority header field being transmitted, unless the server has the knowledge that no intermediaries are coalescing requests from multiple clients. That can be determined by the settings when the intermediaries support this specification (see <a href="#settings-this-scheme" class="xref">Section 3.2.2</a>), or else through configuration.</p>
<p id="rfc.section.8.1.1.p.4">A server can determine if a request came from an intermediary through configuration, or by consulting if that request contains one of the following header fields:</p>
<p></p>

<ul>
<li>CDN-Loop (<a href="#RFC8586" class="xref">[RFC8586]</a>)</li>
<li>Forwarded, X-Forwarded-For (<a href="#RFC7239" class="xref">[RFC7239]</a>)</li>
<li>Via (<a href="#RFC7230" class="xref">[RFC7230]</a>, Section 5.7.1)</li>
</ul>
<p id="rfc.section.8.1.1.p.6">Responding to requests coming through an intermediary in a round-robin manner works well when the network bottleneck exists between the intermediary and the end client, as the intermediary would be buffering the responses and then be forwarding the chunks of those buffered responses based on the prioritization scheme it implements. A sophisticated server MAY use a weighted round-robin reflecting the urgencies expressed in the requests, so that less urgent responses would receive less bandwidth in case the bottleneck exists between the server and the intermediary.</p>
<h1 id="rfc.section.8.1.2">
<a href="#rfc.section.8.1.2">8.1.2.</a> <a href="#http1x-back-ends" id="http1x-back-ends">HTTP/1.x Back Ends</a>
</h1>
<p id="rfc.section.8.1.2.p.1">It is common for CDN infrastructure to support different HTTP versions on the front end and back end. For instance, the client-facing edge might support HTTP/2 and HTTP/3 while communication to back end servers is done using HTTP/1.1. Unlike with connection coalescing, the CDN will &#8220;de-mux&#8221; requests into discrete connections to the back end. As HTTP/1.1 and older do not provide a way to concurrently transmit multiple responses, there is no immediate fairness issue in protocol. However, back end servers MAY still use client headers for request scheduling. Back end servers SHOULD only schedule based on client priority information where that information can be scoped to individual end clients. Authentication and other session information might provide this linkability.</p>
<h1 id="rfc.section.8.1.3">
<a href="#rfc.section.8.1.3">8.1.3.</a> <a href="#intentional-introduction-of-unfairness" id="intentional-introduction-of-unfairness">Intentional Introduction of Unfairness</a>
</h1>
<p id="rfc.section.8.1.3.p.1">It is sometimes beneficial to deprioritize the transmission of one connection over others, knowing that doing so introduces a certain amount of unfairness between the connections and therefore between the requests served on those connections.</p>
<p id="rfc.section.8.1.3.p.2">For example, a server might use a scavenging congestion controller on connections that only convey background priority responses such as software update images. Doing so improves responsiveness of other connections at the cost of delaying the delivery of updates.</p>
<p id="rfc.section.8.1.3.p.3">Also, a client MAY use the priority values for making local scheduling choices for the requests it initiates.</p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#considerations" id="considerations">Considerations</a>
</h1>
<h1 id="rfc.section.9.1">
<a href="#rfc.section.9.1">9.1.</a> <a href="#why-use-an-end-to-end-header-field" id="why-use-an-end-to-end-header-field">Why use an End-to-End Header Field?</a>
</h1>
<p id="rfc.section.9.1.p.1">Contrary to the prioritization scheme of HTTP/2 that uses a hop-by-hop frame, the Priority header field is defined as end-to-end.</p>
<p id="rfc.section.9.1.p.2">The rationale is that the Priority header field transmits how each response affects the client&#8217;s processing of those responses, rather than how relatively urgent each response is to others.  The way a client processes a response is a property associated to that client generating that request.  Not that of an intermediary.  Therefore, it is an end-to-end property.  How these end-to-end properties carried by the Priority header field affect the prioritization between the responses that share a connection is a hop-by-hop issue.</p>
<p id="rfc.section.9.1.p.3">Having the Priority header field defined as end-to-end is important for caching intermediaries.  Such intermediaries can cache the value of the Priority header field along with the response, and utilize the value of the cached header field when serving the cached response, only because the header field is defined as end-to-end rather than hop-by-hop.</p>
<p id="rfc.section.9.1.p.4">It should also be noted that the use of a header field carrying a textual value makes the prioritization scheme extensible; see the discussion below.</p>
<h1 id="rfc.section.9.2">
<a href="#rfc.section.9.2">9.2.</a> <a href="#why-do-urgencies-have-meanings" id="why-do-urgencies-have-meanings">Why do Urgencies Have Meanings?</a>
</h1>
<p id="rfc.section.9.2.p.1">One of the aims of this specification is to define a mechanism for merging client- and server-provided hints for prioritizing the responses.  For that to work, each urgency level needs to have a well-defined meaning.  As an example, a server can assign the highest precedence among the supplementary responses to an HTTP response carrying an icon, because the meaning of <samp>u=2</samp> is shared among the endpoints.</p>
<p id="rfc.section.9.2.p.2">This specification restricts itself to defining a minimum set of urgency levels in order to provide sufficient granularity for prioritizing responses for ordinary web browsing, at minimal complexity.</p>
<p id="rfc.section.9.2.p.3">However, that does not mean that the prioritization scheme would forever be stuck to the eight levels.  The design provides extensibility.  If deemed necessary, it would be possible to subdivide any of the eight urgency levels that are currently defined.  Or, a graphical user-agent could send a <samp>visible</samp> parameter to indicate if the resource being requested is within the viewport.</p>
<p id="rfc.section.9.2.p.4">A server can combine the hints provided in the Priority header field with other information in order to improve the prioritization of responses.  For example, a server that receives requests for a font <a href="#RFC8081" class="xref">[RFC8081]</a> and images with the same urgency might give higher precedence to the font, so that a visual client can render textual information at an early moment.</p>
<h1 id="rfc.section.9.3">
<a href="#rfc.section.9.3">9.3.</a> <a href="#can-an-intermediary-send-its-own-signal" id="can-an-intermediary-send-its-own-signal">Can an Intermediary Send its own Signal?</a>
</h1>
<p id="rfc.section.9.3.p.1">There might be a benefit in recommending a coalescing intermediary to embed its own prioritization hints into the HTTP request that it forwards to the backend server, as otherwise the Priority header field would not be as helpful to the backend (see <a href="#fairness" class="xref">Section 8.1</a>).</p>
<p id="rfc.section.9.3.p.2">One way of achieving that, without dropping the original signal, would be to let the intermediary express its own signal using the Priority header field, at the same time transplanting the original value to a different header field.</p>
<p id="rfc.section.9.3.p.3">As an example, when a client sends an HTTP request carrying a priority of <samp>u=0</samp> and the intermediary wants to instead associate <samp>u=1; i=?1</samp>, the intermediary would send a HTTP request that contains the following two header fields to the backend server:</p>
<pre>
priority = u=1; i=?1
original-priority = u=0
</pre>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> <a href="#iana-considerations" id="iana-considerations">IANA Considerations</a>
</h1>
<p id="rfc.section.10.p.1">This specification registers the following entry in the Permanent Message Header Field Names registry established by <a href="#RFC3864" class="xref">[RFC3864]</a>:</p>
<p></p>

<dl>
<dt>Header field name:</dt>
<dd style="margin-left: 8">Priority</dd>
<dt>Applicable protocol:</dt>
<dd style="margin-left: 8">http</dd>
<dt>Status:</dt>
<dd style="margin-left: 8">standard</dd>
<dt>Author/change controller:</dt>
<dd style="margin-left: 8">IETF</dd>
<dt>Specification document(s):</dt>
<dd style="margin-left: 8">This document</dd>
<dt>Related information:</dt>
<dd style="margin-left: 8">n/a</dd>
</dl>
<p id="rfc.section.10.p.3">This specification registers the following entry in the HTTP/2 Settings registry established by <a href="#RFC7540" class="xref">[RFC7540]</a>:</p>
<p></p>

<dl>
<dt>Name:</dt>
<dd style="margin-left: 8">SETTINGS_PRIORITIES</dd>
<dt>Code:</dt>
<dd style="margin-left: 8">0x9</dd>
<dt>Initial value:</dt>
<dd style="margin-left: 8">0</dd>
<dt>Specification:</dt>
<dd style="margin-left: 8">This document</dd>
</dl>
<p id="rfc.section.10.p.5">This specification registers the following entry in the HTTP/2 Settings registry established by <a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a>:</p>
<p></p>

<dl>
<dt>Name:</dt>
<dd style="margin-left: 8">SETTINGS_PRIORITIES</dd>
<dt>Code:</dt>
<dd style="margin-left: 8">0x9</dd>
<dt>Initial value:</dt>
<dd style="margin-left: 8">0</dd>
<dt>Specification:</dt>
<dd style="margin-left: 8">This document</dd>
</dl>
<p id="rfc.section.10.p.7">This specification registers the following entry in the HTTP/2 Frame Type registry established by <a href="#RFC7540" class="xref">[RFC7540]</a>:</p>
<p></p>

<dl>
<dt>Frame Type:</dt>
<dd style="margin-left: 8">PRIORITY_UPDATE</dd>
<dt>Code:</dt>
<dd style="margin-left: 8">0xF</dd>
<dt>Specification:</dt>
<dd style="margin-left: 8">This document</dd>
</dl>
<p id="rfc.section.10.p.9">This specification registers the following entries in the HTTP/3 Frame Type registry established by <a href="#I-D.ietf-quic-http" class="xref">[I-D.ietf-quic-http]</a>:</p>
<p></p>

<dl>
<dt>Frame Type:</dt>
<dd style="margin-left: 8">PRIORITY_UPDATE</dd>
<dt>Code:</dt>
<dd style="margin-left: 8">0xF</dd>
<dt>Specification:</dt>
<dd style="margin-left: 8">This document</dd>
</dl>
<h1 id="rfc.section.10.1">
<a href="#rfc.section.10.1">10.1.</a> <a href="#http-prioritization-scheme-registry" id="http-prioritization-scheme-registry">HTTP Prioritization Scheme Registry</a>
</h1>
<p id="rfc.section.10.1.p.1">This document establishes a registry for HTTP prioritization scheme codes to be used in conjunction with the SETTINGS_PRIORITIES parameter. The &#8220;HTTP Prioritization Scheme&#8221; registry manages an 8-bit space. The &#8220;HTTP Prioritization Scheme&#8221; registry operates under either of the &#8220;IETF Review&#8221; or &#8220;IESG Approval&#8221; policies <a href="#RFC5226" class="xref">[RFC5226]</a> for values between 0x00 and 0xef, with values between 0xf0 and 0xff being reserved for Experimental Use.</p>
<p id="rfc.section.10.1.p.2">New entries in this registry require the following information:</p>
<p></p>

<dl>
<dt>Prioritization Scheme:</dt>
<dd style="margin-left: 8">A name or label for the prioritization scheme.</dd>
<dt>Code:</dt>
<dd style="margin-left: 8">The 8-bit code assigned to the prioritization scheme.</dd>
<dt>Specification:</dt>
<dd style="margin-left: 8">A reference to a specification that includes a description of the prioritization scheme.</dd>
</dl>
<p id="rfc.section.10.1.p.4">The entries in the following table are registered by this document.</p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="left">Prioritization Scheme</th>
<th class="center">Code</th>
<th class="left">Specification</th>
</tr></thead>
<tbody>
<tr>
<td class="left">H2_TREE</td>
<td class="center">1</td>
<td class="left"><a href="#settings-h2-scheme" class="xref">Section 3.2.1</a></td>
</tr>
<tr>
<td class="left">URGENCY</td>
<td class="center">2</td>
<td class="left"><a href="#settings-this-scheme" class="xref">Section 3.2.2</a></td>
</tr>
</tbody>
</table>
<h1 id="rfc.references">
<a href="#rfc.references">11.</a> References</h1>
<h1 id="rfc.references.1">
<a href="#rfc.references.1">11.1.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.ietf-quic-http">[I-D.ietf-quic-http]</b></td>
<td class="top">
<a>Bishop, M.</a>, "<a href="https://tools.ietf.org/html/draft-ietf-quic-http-23">Hypertext Transfer Protocol Version 3 (HTTP/3)</a>", Internet-Draft draft-ietf-quic-http-23, September 2019.</td>
</tr>
<tr>
<td class="reference"><b id="I-D.ietf-quic-transport">[I-D.ietf-quic-transport]</b></td>
<td class="top">
<a>Iyengar, J.</a> and <a>M. Thomson</a>, "<a href="https://tools.ietf.org/html/draft-ietf-quic-transport-23">QUIC: A UDP-Based Multiplexed and Secure Transport</a>", Internet-Draft draft-ietf-quic-transport-23, September 2019.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5226">[RFC5226]</b></td>
<td class="top">
<a>Narten, T.</a> and <a>H. Alvestrand</a>, "<a href="https://tools.ietf.org/html/rfc5226">Guidelines for Writing an IANA Considerations Section in RFCs</a>", RFC 5226, DOI 10.17487/RFC5226, May 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7230">[RFC7230]</b></td>
<td class="top">
<a>Fielding, R.</a> and <a>J. Reschke</a>, "<a href="https://tools.ietf.org/html/rfc7230">Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</a>", RFC 7230, DOI 10.17487/RFC7230, June 2014.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7540">[RFC7540]</b></td>
<td class="top">
<a>Belshe, M.</a>, <a>Peon, R.</a> and <a>M. Thomson</a>, "<a href="https://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>", RFC 7540, DOI 10.17487/RFC7540, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="STRUCTURED-HEADERS">[STRUCTURED-HEADERS]</b></td>
<td class="top">
<a>Nottingham, M.</a> and <a>P. Kamp</a>, "<a href="https://tools.ietf.org/html/draft-ietf-httpbis-header-structure-14">Structured Headers for HTTP</a>", Internet-Draft draft-ietf-httpbis-header-structure-14, October 2019.</td>
</tr>
</tbody></table>
<h1 id="rfc.references.2">
<a href="#rfc.references.2">11.2.</a> Informative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="I-D.lassey-priority-setting">[I-D.lassey-priority-setting]</b></td>
<td class="top">
<a>Lassey, B.</a> and <a>L. Pardue</a>, "<a href="https://tools.ietf.org/html/draft-lassey-priority-setting-00">Declaring Support for HTTP/2 Priorities</a>", Internet-Draft draft-lassey-priority-setting-00, July 2019.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3864">[RFC3864]</b></td>
<td class="top">
<a>Klyne, G.</a>, <a>Nottingham, M.</a> and <a>J. Mogul</a>, "<a href="https://tools.ietf.org/html/rfc3864">Registration Procedures for Message Header Fields</a>", BCP 90, RFC 3864, DOI 10.17487/RFC3864, September 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7234">[RFC7234]</b></td>
<td class="top">
<a>Fielding, R.</a>, <a>Nottingham, M.</a> and <a>J. Reschke</a>, "<a href="https://tools.ietf.org/html/rfc7234">Hypertext Transfer Protocol (HTTP/1.1): Caching</a>", RFC 7234, DOI 10.17487/RFC7234, June 2014.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7239">[RFC7239]</b></td>
<td class="top">
<a>Petersson, A.</a> and <a>M. Nilsson</a>, "<a href="https://tools.ietf.org/html/rfc7239">Forwarded HTTP Extension</a>", RFC 7239, DOI 10.17487/RFC7239, June 2014.</td>
</tr>
<tr>
<td class="reference"><b id="RFC8081">[RFC8081]</b></td>
<td class="top">
<a>Lilley, C.</a>, "<a href="https://tools.ietf.org/html/rfc8081">The "font" Top-Level Media Type</a>", RFC 8081, DOI 10.17487/RFC8081, February 2017.</td>
</tr>
<tr>
<td class="reference"><b id="RFC8586">[RFC8586]</b></td>
<td class="top">
<a>Ludin, S.</a>, <a>Nottingham, M.</a> and <a>N. Sullivan</a>, "<a href="https://tools.ietf.org/html/rfc8586">Loop Detection in Content Delivery Networks (CDNs)</a>", RFC 8586, DOI 10.17487/RFC8586, April 2019.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.A">
<a href="#rfc.appendix.A">Appendix A.</a> <a href="#acknowledgements" id="acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.A.p.1">Roy Fielding presented the idea of using a header field for representing priorities in <a href="http://tools.ietf.org/agenda/83/slides/slides-83-httpbis-5.pdf">http://tools.ietf.org/agenda/83/slides/slides-83-httpbis-5.pdf</a>.  In <a href="https://github.com/pmeenan/http3-prioritization-proposal">https://github.com/pmeenan/http3-prioritization-proposal</a>, Patrick Meenan advocates for representing the priorities using a tuple of urgency and concurrency. The negotiation scheme described in this document is based on <a href="#I-D.lassey-priority-setting" class="xref">[I-D.lassey-priority-setting]</a>, authored by Brad Lassey and Lucas Pardue.</p>
<p id="rfc.section.A.p.2">The motivation for defining an alternative to HTTP/2 priorities is drawn from discussion within the broad HTTP community. Special thanks to Roberto Peon, Martin Thomson and Netflix for text that was incorporated explicitly in this document.</p>
<p id="rfc.section.A.p.3">In addition to the people above, this document owes a lot to the extensive discussion in the HTTP priority design team, consisting of Alan Frindell, Andrew Galloni, Craig Taylor, Ian Swett, Kazuho Oku, Lucas Pardue, Matthew Cox, Mike Bishop, Roberto Peon, Robin Marx, Roy Fielding.</p>
<h1 id="rfc.appendix.B">
<a href="#rfc.appendix.B">Appendix B.</a> <a href="#change-log" id="change-log">Change Log</a>
</h1>
<h1 id="rfc.appendix.B.1">
<a href="#rfc.appendix.B.1">B.1.</a> <a href="#since-draft-kazuho-httpbis-priority-03" id="since-draft-kazuho-httpbis-priority-03">Since draft-kazuho-httpbis-priority-03</a>
</h1>
<p></p>

<ul><li>Changed numbering from [-1,6] to [0,7] (#78)</li></ul>
<h1 id="rfc.appendix.B.2">
<a href="#rfc.appendix.B.2">B.2.</a> <a href="#since-draft-kazuho-httpbis-priority-02" id="since-draft-kazuho-httpbis-priority-02">Since draft-kazuho-httpbis-priority-02</a>
</h1>
<p></p>

<ul>
<li>Consolidation of the problem statement (#61, #73)</li>
<li>Define SETTINGS_PRIORITIES for negotiation (#58, #69)</li>
<li>Define PRIORITY_UPDATE frame for HTTP/2 and HTTP/3 (#51)</li>
<li>Explain fairness issue and mitigations (#56)</li>
</ul>
<h1 id="rfc.appendix.B.3">
<a href="#rfc.appendix.B.3">B.3.</a> <a href="#since-draft-kazuho-httpbis-priority-01" id="since-draft-kazuho-httpbis-priority-01">Since draft-kazuho-httpbis-priority-01</a>
</h1>
<p></p>

<ul><li>Explain how reprioritization might be supported.</li></ul>
<h1 id="rfc.appendix.B.4">
<a href="#rfc.appendix.B.4">B.4.</a> <a href="#since-draft-kazuho-httpbis-priority-00" id="since-draft-kazuho-httpbis-priority-00">Since draft-kazuho-httpbis-priority-00</a>
</h1>
<p></p>

<ul><li>Expand urgency levels from 3 to 8.</li></ul>
<h1 id="rfc.authors"><a href="#rfc.authors">Authors' Addresses</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Kazuho Oku</span> 
	  <span class="n hidden">
		<span class="family-name">Oku</span>
	  </span>
	</span>
	<span class="org vcardline">Fastly</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:kazuhooku@gmail.com">kazuhooku@gmail.com</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Lucas Pardue</span> 
	  <span class="n hidden">
		<span class="family-name">Pardue</span>
	  </span>
	</span>
	<span class="org vcardline">Cloudflare</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:lucaspardue.24.7@gmail.com">lucaspardue.24.7@gmail.com</a></span>

  </address>
</div>

</body>
</html>

